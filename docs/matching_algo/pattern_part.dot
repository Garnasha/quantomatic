digraph {
    node [shape=box]
    edge [fontsize=10]
    
    start [color=green]
    normalise [label="normalise"]
    addunmatched [label="add unmatched concrete vertices\n(except those in bare wires)\nto UC, UW or UN as appropriate"]
    match [label="apply concrete matching",color=red]
    morebang [label="has more !-boxes?"]
    morebang1 [label="has more !-boxes?"]
    pickbang [label="pick first top-level !-box"]
    schedule [label="add vertices in P adjacent to\nmodified !-boxes to PS"]
    killcomplete [label="kill all !-boxes that\nare adjacent to completely\nmatched node-vertices"]
    nopartial [label="is P empty?"]
    die [label=die,color=blue]
    emptywires [label="match bare wires"]
    done [label="return match",color=blue]
    
    start -> normalise -> addunmatched -> match
    match -> morebang [label="foreach\nmatching",color=red]
    morebang -> killcomplete [label=yes]
    killcomplete -> morebang1
    morebang1 -> pickbang [label=yes]
    morebang1 -> nopartial [label=no]
    pickbang -> schedule [label="EXPAND",color=red]
    pickbang -> morebang [label="KILL",color=red]
    schedule -> addunmatched
    morebang -> nopartial [label=no]
    nopartial -> emptywires [label=yes]
    nopartial -> die [label=no]
    emptywires -> done [label="foreach\nmatching",color=red]
}
